version: 2.1
orbs: 
  gcp-gcr: circleci/gcp-gcr@0.15.0

jobs:
  build-and-push:
    executor: gcp-gcr/default
    steps:
      - checkout

  oanda-stream_build_amd64:
    docker:
      - image: cimg/base:2021.04
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    resource_class: medium+
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: "oanda-stream: Build (amd64)"
          working_directory: services/oanda_stream
          command: make build
      - run:
          name: "oanda-stream: Linting (amd64)"
          working_directory: services/oanda_stream
          command: make linting
      - run:
          name: "oanda-stream: Unit Test (amd64)"
          working_directory: services/oanda_stream
          command: make unit-test
      - gcp-gcr/gcr-auth:
          registry-url: "eu.gcr.io/brushed-charts"
      - run: 
          name: "oanda-stream: push to registry (amd64)"
          working_directory: services/oanda_stream
          command: make push-amd64
      # - run: 
      #     name: "oanda-stream: Export to tar file (amd64)"
      #     working_directory: services/oanda_stream
      #     command: make save-amd64
      # - persist_to_workspace:
      #     root: /tmp
      #     paths:
      #       - docker_save_path/ 


  oanda-stream_build_arm64:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    steps:
      - checkout
      - run:
          name: "oanda-stream: Build (arm64)"
          working_directory: services/oanda_stream
          command: make build
      - run:
          name: "oanda-stream: Linting (arm64)"
          working_directory: services/oanda_stream
          command: make linting
      - run:
          name: "oanda-stream: Unit Test (arm64)"
          working_directory: services/oanda_stream
          command: make unit-test
      - gcp-gcr/gcr-auth:
          registry-url: "eu.gcr.io/brushed-charts"
      - run: 
          name: "oanda-stream: push to registry (arm64)"
          working_directory: services/oanda_stream
          command: make push-arm64
      # - run: 
      #     name: "oanda-stream: Export to tar file (arm64)"
      #     working_directory: services/oanda_stream
      #     command: make save-arm64
      # - persist_to_workspace:
      #     root: /tmp
      #     paths:
      #       - docker_save_path/
  

  push-multi-arch:
    docker:
      - image: cimg/base:2021.04
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    resource_class: small
    steps:
      - attach_workspace:
          at: /tmp/
      - run:
          name: "list cache files"
          working_directory: /tmp/docker_save_path
          command: ls -l /tmp/docker_save_path ; ls -l /tmp/docker_save_path/docker_save_path
  


workflows:
  test_workflow:
    jobs:
      - oanda-stream_build_amd64:
          context: brushed-charts
      - oanda-stream_build_arm64:
          context: brushed-charts
      # - push-multi-arch:
      #     requires:
      #       - oanda-stream_build_amd64
      #       - oanda-stream_build_arm64
