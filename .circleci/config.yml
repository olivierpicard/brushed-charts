version: 2.1

orbs:
  helm: circleci/helm@2.0.1

commands:
  gcloud-snap-install:
    description: "Install gcloud using snap."
    steps:
      - run:
          name: "Install gcloud via snap"
          command: "sudo snap install google-cloud-cli --classic"
  gcloud-activate:
    steps:
      - run:
          name: "Init gcloud"
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
  gcloud-configure-docker:
    steps:
      - run:
          name: "Configure docker to use gcloud artifact repository in europe"
          command: gcloud --quiet auth configure-docker europe-docker.pkg.dev
  gcloud-get-kubeconfig:
    steps:
      - run:
          name: "Retrieve the kubeconfig file from gke-autpilot-paris"
          command: gcloud container clusters get-credentials my-cluster
  build-and-push-command:
    parameters:
      service_path:
        type: string
      image_name:
        type: string
    steps:
      - checkout
      - gcloud-snap-install
      - gcloud-activate
      - gcloud-configure-docker
      - run:
          name: "<< parameters.image_name >>: Build ($BUILD_ARCHITECTURE)"
          working_directory: << parameters.service_path >>
          command: make build
      - run:
          name: "<< parameters.image_name >>: Linting ($BUILD_ARCHITECTURE)"
          working_directory: << parameters.service_path >>
          command: make linting
      - run:
          name: "<< parameters.image_name >>: Unit Test ($BUILD_ARCHITECTURE)"
          working_directory: << parameters.service_path >>
          command: make unit-test
      - run: 
          name: "<< parameters.image_name >>: push to registry ($BUILD_ARCHITECTURE)"
          working_directory: << parameters.service_path >>
          command: make push-$BUILD_ARCHITECTURE

jobs:
  build-and-push-amd64:
    machine:
      image: ubuntu-2004:current
    resource_class: medium
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
      GOOGLE_COMPUTE_REGION: europe-west9
      BUILD_ARCHITECTURE: "amd64"
    parallelism: 10
    steps:
      - build-and-push-command:
          image_name: oanda-stream 
          service_path: "services/oanda_stream"

  build-and-push-arm64:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
      GOOGLE_COMPUTE_REGION: europe-west9
      BUILD_ARCHITECTURE: "arm64"
    parallelism: 10
    steps:
      - build-and-push-command:
          image_name: oanda-stream 
          service_path: "services/oanda_stream"

  push-multi-arch:
    parameters:
      service_path:
        type: string
      image_name:
        type: string
    docker:
      - image: google/cloud-sdk
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    resource_class: small
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
    steps:
      - checkout
      - gcloud-activate
      - gcloud-configure-docker
      - run:
          name: "<< parameters.image_name >>: create multi-arch manifest"
          working_directory: << parameters.service_path >>
          command: make arch-fusion
      - run:
          name: "<< parameters.image_name >>: push manifest"
          working_directory: << parameters.service_path >>
          command: make push-manifest

  archive-helm-chart:
    docker:
      - image: google/cloud-sdk
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    resource_class: small
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
    steps:
      - checkout
      - gcloud-activate
      - gcloud-configure-docker
      - helm/install-helm-client
      - run:
          name: "Package brushed-charts helm chart"
          working_directory: helm-charts
          command: make package
      - run:
          name: "Push packaged charts to registry (Google Artifact Registry)"
          working_directory: helm-charts
          command: make push
          

workflows:
  build-and-push:
    jobs:
      - archive-helm-chart:
          name: archive-helm-chart
          context: brushed-charts
      -  build-and-push-amd64:
          name: build-and-push_amd64
          context: brushed-charts
      -  build-and-push-arm64:
          name: build-and-push_arm64
          context: brushed-charts
      - push-multi-arch:
          context: brushed-charts
          service_path: "services/oanda_stream"
          image_name: oanda-stream
          requires:
            - build-and-push_amd64
            - build-and-push_arm64
            - archive-helm-chart
