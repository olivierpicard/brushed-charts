version: 2.1

jobs:
  oanda-stream_build-push_amd64:
    docker:
      - image: google/cloud-sdk
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
      GOOGLE_COMPUTE_REGION: europe-west1
    resource_class: medium+
    working_directory: ~/services/oanda_stream
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: "oanda-stream: init gcloud"
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet auth configure-docker europe-docker.pkg.dev
      - run:
          name: "oanda-stream: Build (amd64)"
          command: make build
      - run:
          name: "oanda-stream: Linting (amd64)"
          command: make linting
      - run:
          name: "oanda-stream: Unit Test (amd64)"
          command: make unit-test
      - run: 
          name: "oanda-stream: Push to registry (amd64)"
          command: make push-amd64


  oanda-stream_build-push_arm64:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
      GOOGLE_COMPUTE_REGION: europe-west1
    steps:
      - checkout
      - run:
          name: "Install gcloud via snap"
          command: "snap install google-cloud-cli --classic"
      - run:
          name: "Init gcloud"
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet auth configure-docker europe-docker.pkg.dev
      - run:
          name: "oanda-stream: Build (arm64)"
          working_directory: services/oanda_stream
          command: make build
      - run:
          name: "oanda-stream: Linting (arm64)"
          working_directory: services/oanda_stream
          command: make linting
      - run:
          name: "oanda-stream: Unit Test (arm64)"
          working_directory: services/oanda_stream
          command: make unit-test
      - run: 
          name: "oanda-stream: push to registry (arm64)"
          working_directory: services/oanda_stream
          command: make push-arm64
  

  push-multi-arch:
    docker:
      - image: google/cloud-sdk
        auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
    resource_class: small
    environment:
      GOOGLE_PROJECT_ID: brushed-charts
      GOOGLE_COMPUTE_REGION: europe-west1
    steps:
      - checkout
      - run:
          name: "Init gcloud"
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet auth configure-docker europe-docker.pkg.dev
      - run:
          name: "oanda-stream: create multi-arch manifest"
          working_directory: services/oanda_stream
          command: make arch-fusion
      - run:
          name: "oanda-stream: push manifest"
          working_directory: services/oanda_stream
          command: make push-manifest
  


workflows:
  test_workflow:
    jobs:
      - oanda-stream_build-push_amd64:
          context: brushed-charts
      - oanda-stream_build-push_arm64:
          context: brushed-charts
      - push-multi-arch:
          context: brushed-charts
          requires:
            - oanda-stream_build-push_amd64
            - oanda-stream_build-push_arm64
