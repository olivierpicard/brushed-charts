version: "3.8"

services:
  mongodb:
    image: mongo:4.4
    restart: on-failure
    container_name: mongodb
    hostname: mongodb
    ports:
      - 127.0.0.1:27017:27017
    volumes: 
      - /var/volumes/mongo-data/${PROFIL}:/data/db
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"
    deploy:
      resources:
        limits: 
          memory: 400M
        reservations:
          memory: 300M  


  oanda_bigquery:
    build: ./services/oanda_bigquery
    image: eu.gcr.io/brushed-charts/oanda_bigquery:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_bigquery 
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"
    deploy:
      resources:
        limits: 
          memory: 100M


  oanda_fetcher:
    build: ./services/oanda_fetcher
    image: eu.gcr.io/brushed-charts/oanda_fetcher:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_fetcher
    env_file: 
      - ./env/services.env
      - ./env/secrets.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  oanda_history:
    build: ./services/oanda_history
    image: eu.gcr.io/brushed-charts/oanda_history:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_history
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  oanda_watchlist:
    build: ./services/oanda_watchlist
    image: eu.gcr.io/brushed-charts/oanda_watchlist:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_watchlist
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  oanda_clean_history:
    build: ./services/oanda_clean_history
    image: eu.gcr.io/brushed-charts/oanda_clean_history:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_clean_history
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  presence_bigquery_oanda_price:
    build: ./services/presence_bigquery
    image: eu.gcr.io/brushed-charts/presence_bigquery:${PROFIL}-latest
    restart: on-failure
    container_name: presence_bigquery_oanda_price
    environment: 
      - BIGQUERY_TABLE_PATH_TO_MONITOR_PRESENCE=brushed-charts.${PROFIL}.oanda_prices
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
      - ./env/presence.env
      - ./env/secrets.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"
        
  
  oanda_graphql:
    build: ./services/oanda_graphql
    image: eu.gcr.io/brushed-charts/oanda_graphql:${PROFIL}-latest
    restart: on-failure
    container_name: oanda_graphql
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"
    

  kraken_ohlc_websocket_minute:
    build: ./services/kraken_ohlc_websocket
    image: eu.gcr.io/brushed-charts/kraken_ohlc_fetcher:${PROFIL}-latest
    restart: on-failure
    container_name: kraken_ohlc_websocket_minute
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    environment:  
      - KRAKEN_OHLC_GRANULARITY=1  # MINUTES
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  kraken_ohlc_websocket_hour:
    build: ./services/kraken_ohlc_websocket
    image: eu.gcr.io/brushed-charts/kraken_ohlc_fetcher:${PROFIL}-latest
    restart: on-failure
    container_name: kraken_ohlc_websocket_hour
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    environment: 
      - KRAKEN_OHLC_GRANULARITY=60  # MINUTES
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"

  
  kraken_ohlc_websocket_day:
    build: ./services/kraken_ohlc_websocket
    image: eu.gcr.io/brushed-charts/kraken_ohlc_fetcher:${PROFIL}-latest
    restart: on-failure
    container_name: kraken_ohlc_websocket_day
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    environment: 
      - KRAKEN_OHLC_GRANULARITY=1440  # MINUTES
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  kraken_ohlc_bigquery:
    build: ./services/kraken_ohlc_bigquery
    image: eu.gcr.io/brushed-charts/kraken_ohlc_bigquery:${PROFIL}-latest
    restart: on-failure
    container_name: kraken_ohlc_bigquery
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"


  kraken_ohlc_clean:
    build: ./services/kraken_ohlc_clean
    image: eu.gcr.io/brushed-charts/kraken_ohlc_clean:${PROFIL}-latest
    restart: on-failure
    container_name: kraken_ohlc_clean
    env_file: 
      - ./env/services.env
      - ./env/services.${PROFIL}.env
    volumes: 
      - type: bind
        source: /etc/brushed-charts/
        target: /etc/brushed-charts/
    logging: 
      driver: "json-file"
      options: 
        max-size: "5m"
        max-file: "10"
